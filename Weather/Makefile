# ===============================
# üíª WeatherCLI Makefile (macOS ARM / Intel)
# ===============================

# Kompilator (clang √§r standard p√• macOS)
CC := clang

# Kataloger
SRC_DIR := src
BUILD_DIR := build

# H√§mta OpenSSL-prefix via Homebrew
OPENSSL_PREFIX := $(shell brew --prefix openssl@3)

# Kompilatorflaggor
CFLAGS := -std=c17 -Wall -Wextra -Wno-deprecated-non-prototype -Wno-unused-variable -Wno-sign-conversion \
           -Wno-unused-function -g \
           -I$(OPENSSL_PREFIX)/include \
           -Iincludes -Isrc/libs/cjson

# L√§nkningsflaggor
LDFLAGS := -L$(OPENSSL_PREFIX)/lib -lssl -lcrypto -lcurl

# K√§ll- och objektfiler
SRC := $(shell find -L $(SRC_DIR) -type f -name '*.c')
OBJ := $(patsubst %.c,$(BUILD_DIR)/%.o,$(SRC))
DEP := $(OBJ:.o=.d)

# Bin√§rfil
BIN := Weather

# ===============================
# üß© Byggm√•l
# ===============================

# Standardm√•l
all: $(BIN)
	@echo "‚úÖ Build complete for macOS M3."

# L√§nkning
$(BIN): $(OBJ)
	@echo "üîó Linking $@..."
	@$(CC) $(OBJ) -o $@ $(LDFLAGS)

# Bygg varje objektfil
$(BUILD_DIR)/%.o: %.c
	@echo "‚öôÔ∏è  Compiling $<..."
	@mkdir -p $(dir $@)
	@$(CC) $(CFLAGS) -MMD -MP -c $< -o $@

# K√∂r programmet
run: $(BIN)
	@echo "üöÄ Running WeatherCLI..."
	@./$(BIN)

# ===============================
# üßπ Hj√§lpm√•l
# ===============================

# Rensa
clean:
	@echo "üßπ Cleaning build files..."
	@rm -rf $(BUILD_DIR) $(BIN)

# Debug
print:
	@echo "SRC = $(SRC)"
	@echo "OBJ = $(OBJ)"
	@echo "OPENSSL_PREFIX = $(OPENSSL_PREFIX)"

# ===============================
# üß† Extra
# ===============================

# Valgrind (inte tillg√§nglig p√• macOS ARM)
valgrind: $(BIN)
	@echo "‚ö†Ô∏è  Valgrind not available on macOS ARM64 by default."
	@./$(BIN)

# Ignorera dep-filer om de inte finns √§nnu
-include $(DEP)

.PHONY: all run clean print valgrind
